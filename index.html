<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <title>Jira Lambda Caller</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 40px 16px;
      display: flex;
      justify-content: center;
      background: #f5f5f5;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08);
      padding: 32px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 24px;
      color: #111;
      text-align: center;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      display: block;
      margin-bottom: 6px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-row input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      font-size: 15px;
      box-sizing: border-box;
    }

    button {
      padding: 14px;
      font-size: 16px;
      background: #0052cc;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button:not(:disabled):hover {
      background: #003d99;
    }

    .loading-indicator {
      display: none;
      margin-top: 16px;
      align-items: center;
      gap: 10px;
      color: #0052cc;
      font-weight: 600;
    }

    .loading-indicator.active {
      display: flex;
    }

    .loading-indicator .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0, 82, 204, 0.2);
      border-top-color: #0052cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #responseBox {
      margin-top: 28px;
      padding: 20px;
      border-radius: 12px;
      background: #0c1d33;
      color: #d9e1f2;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 140px;
    }

    .helper {
      font-size: 13px;
      color: #667085;
      margin-top: 4px;
    }

    .status {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .status.error {
      color: #d92d20;
    }

    .status.success {
      color: #039855;
    }
  </style>
</head>

<body>
  <main class="card">
    <h1>Jira 자동 번역 호출</h1>
    <form id="jiraForm">
      <div>
        <label for="issueInput">Issue</label>
        <input id="issueInput" name="issue" placeholder="예) P2-70735" autocomplete="off" list="issueHistoryList"
          required />
        <datalist id="issueHistoryList"></datalist>
        <div class="helper">업데이트할 Jira 이슈 키 또는 url을 입력하세요.</div>
      </div>
      <div>
        <label for="updateSelect">Update</label>
        <select id="updateSelect" name="update">
          <option value="true">true</option>
          <option value="false" selected>false</option>
        </select>
        <div class="helper">true 선택 시 업데이트, false 선택 시 조회만 수행.</div>
      </div>
      <div>
        <label for="passwordInput">Password</label>
        <input id="passwordInput" name="password" type="password" placeholder="보안 비밀번호" autocomplete="off" required />
        <div class="helper">보안을 위해 비밀번호를 입력해야 합니다.</div>
      </div>
      <div>
        <div class="checkbox-row">
          <input type="checkbox" id="savePassword" />
          <label for="savePassword" style="margin: 0; font-weight: 500">비밀번호 저장</label>
        </div>
        <div class="helper">공용 기기에서는 사용하지 마세요.</div>
      </div>
      <button type="submit" id="submitBtn">호출</button>
    </form>
    <div id="loadingIndicator" class="loading-indicator" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <span id="elapsedText">0.0초 경과</span>
    </div>
    <section id="responseSection">
      <div id="statusText" class="status">아직 호출하지 않았습니다.</div>
      <pre id="responseBox">응답이 여기에 표시됩니다.</pre>
    </section>
  </main>
  <script>
    const endpoint =
      "https://buqpkgyu4lx35cye3vku6i7xwy0vqcol.lambda-url.ap-northeast-2.on.aws/";
    const form = document.getElementById("jiraForm");
    const issueInput = document.getElementById("issueInput");
    const issueHistoryList = document.getElementById("issueHistoryList");
    const updateSelect = document.getElementById("updateSelect");
    const passwordInput = document.getElementById("passwordInput");
    const savePasswordCheckbox = document.getElementById("savePassword");
    const statusText = document.getElementById("statusText");
    const responseBox = document.getElementById("responseBox");
    const submitBtn = document.getElementById("submitBtn");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const elapsedText = document.getElementById("elapsedText");
    const PASSWORD = "pubgt2";
    const PASSWORD_STORAGE_KEY = "jira-call-password";
    const ISSUE_HISTORY_STORAGE_KEY = "jira-call-issue-history";
    const MAX_ISSUE_HISTORY = 10;
    const buildLog = (data) => JSON.stringify(data, null, 2);
    let loadingInterval = null;

    const storedPassword = localStorage.getItem(PASSWORD_STORAGE_KEY);
    if (storedPassword) {
      passwordInput.value = storedPassword;
      savePasswordCheckbox.checked = true;
    }

    const loadIssueHistory = () => {
      try {
        const raw = localStorage.getItem(ISSUE_HISTORY_STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.warn("Failed to load issue history", e);
        return [];
      }
    };

    const renderIssueHistory = () => {
      const history = loadIssueHistory();
      issueHistoryList.innerHTML = "";
      history.forEach((issue) => {
        const option = document.createElement("option");
        option.value = issue;
        issueHistoryList.appendChild(option);
      });
      if (!issueInput.value && history.length > 0) {
        issueInput.value = history[0];
      }
    };

    const saveIssueHistory = (issue) => {
      if (!issue) return;
      const history = loadIssueHistory().filter((item) => item !== issue);
      history.unshift(issue);
      const trimmed = history.slice(0, MAX_ISSUE_HISTORY);
      localStorage.setItem(ISSUE_HISTORY_STORAGE_KEY, JSON.stringify(trimmed));
      renderIssueHistory();
    };

    renderIssueHistory();

    const parseIssueKey = (input) => {
      const trimmed = input.trim();
      if (!trimmed) return null;

      // 이슈 키 패턴 정의 (PROJECT-NUMBER 형식)
      const issueKeyPattern = /^[A-Z0-9]+-[0-9]+$/i;

      // URL 형식인지 확인 (http:// 또는 https://로 시작)
      // /browse/ 다음에 이슈 키가 오는 경우
      const browseUrlPattern = /^https?:\/\/[^\/]+\/browse\/([A-Z0-9]+-[0-9]+)/i;
      const browseMatch = trimmed.match(browseUrlPattern);
      if (browseMatch) {
        return browseMatch[1].toUpperCase(); // 이슈 키 추출 후 대문자 변환
      }

      // 이미 이슈 키 형식인지 확인
      if (issueKeyPattern.test(trimmed)) {
        return trimmed.toUpperCase(); // 대문자로 정규화
      }

      // URL이지만 다른 형식인 경우, URL 파싱하여 경로에서 이슈 키 추출 시도
      try {
        const url = new URL(trimmed);
        // pathname에서 마지막 경로 세그먼트 확인
        const pathParts = url.pathname.split('/').filter(Boolean);
        for (let i = pathParts.length - 1; i >= 0; i--) {
          const part = pathParts[i];
          if (issueKeyPattern.test(part)) {
            return part.toUpperCase();
          }
        }
      } catch (e) {
        // URL 파싱 실패 시 무시 (일반 텍스트일 수 있음)
      }

      // 그 외의 경우 원본 반환 (기존 동작 유지)
      return trimmed;
    };

    const startLoading = () => {
      const startedAt = Date.now();
      loadingIndicator.classList.add("active");
      elapsedText.textContent = "0.0초 경과";
      loadingInterval = setInterval(() => {
        const elapsed = (Date.now() - startedAt) / 1000;
        elapsedText.textContent = `${elapsed.toFixed(1)}초 경과`;
      }, 100);
    };

    const stopLoading = () => {
      if (loadingInterval) {
        clearInterval(loadingInterval);
        loadingInterval = null;
      }
      loadingIndicator.classList.remove("active");
    };

    const updateSubmitState = () => {
      const hasIssue = issueInput.value.trim().length > 0;
      const passOk = passwordInput.value === PASSWORD;
      submitBtn.disabled = !(hasIssue && passOk);
    };

    updateSubmitState();
    issueInput.addEventListener("input", updateSubmitState);
    issueInput.addEventListener("paste", (event) => {
      // paste 이벤트 후 파싱된 값으로 업데이트
      setTimeout(() => {
        const rawInput = issueInput.value.trim();
        const parsedKey = parseIssueKey(rawInput);
        if (parsedKey && parsedKey !== rawInput) {
          issueInput.value = parsedKey;
          updateSubmitState();
        }
      }, 0);
    });
    passwordInput.addEventListener("input", () => {
      updateSubmitState();
      if (savePasswordCheckbox.checked) {
        localStorage.setItem(PASSWORD_STORAGE_KEY, passwordInput.value);
      }
    });
    savePasswordCheckbox.addEventListener("change", () => {
      if (savePasswordCheckbox.checked) {
        localStorage.setItem(PASSWORD_STORAGE_KEY, passwordInput.value);
      } else {
        localStorage.removeItem(PASSWORD_STORAGE_KEY);
      }
    });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const rawInput = issueInput.value.trim();
      const issueKey = parseIssueKey(rawInput);
      const updateValue = updateSelect.value === "true";
      const passwordValue = passwordInput.value;

      if (!issueKey) {
        statusText.textContent = "Issue 키를 입력해주세요.";
        statusText.className = "status error";
        issueInput.focus();
        return;
      }

      if (passwordValue !== PASSWORD) {
        statusText.textContent = "비밀번호가 일치하지 않습니다.";
        statusText.className = "status error";
        passwordInput.focus();
        return;
      }

      const payload = {
        issue_key: issueKey,
        update: updateValue,
      };
      saveIssueHistory(issueKey);

      statusText.textContent = "호출 중...";
      statusText.className = "status";
      responseBox.textContent = "";
      submitBtn.disabled = true;
      startLoading();

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const text = await res.text();
        const isJson = text.startsWith("{") || text.startsWith("[");
        const parsedBody = isJson ? JSON.parse(text) : text;
        const responseMeta = {
          status: res.status,
          statusText: res.statusText,
          headers: Object.fromEntries(res.headers.entries()),
          body: parsedBody,
        };

        if (!res.ok) {
          statusText.textContent = `오류 발생: ${res.status} ${res.statusText}`;
          statusText.className = "status error";
          responseBox.textContent = buildLog({
            timestamp: new Date().toISOString(),
            request: payload,
            response: responseMeta,
          });
        } else {
          statusText.textContent = "호출 성공";
          statusText.className = "status success";
          responseBox.textContent = buildLog(parsedBody);
        }
      } catch (error) {
        statusText.textContent = "네트워크 오류가 발생했습니다.";
        statusText.className = "status error";
        responseBox.textContent = buildLog({
          timestamp: new Date().toISOString(),
          request: payload,
          error: {
            message: error.message,
            stack: error.stack,
          },
        });
      } finally {
        submitBtn.disabled = false;
        stopLoading();
      }
    });
  </script>
</body>

</html>